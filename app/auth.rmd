Thought for 2s## Plan de Implementación Actualizado: Supabase Auth vía API Routes

### Cambios Principales

En lugar de usar el cliente de Supabase en el frontend, toda la lógica de autenticación se manejará a través de API Routes, manteniendo el código de Supabase 100% del lado del servidor.

---

### Archivos a Crear/Modificar

| # | Archivo | Propósito
|-----|-----|-----
| 1 | `lib/supabase/server.ts` | Cliente Supabase para el servidor
| 2 | `lib/supabase/middleware.ts` | Función para refrescar sesiones
| 3 | `middleware.ts` | Middleware para proteger rutas `/admin/*`
| 4 | `app/api/auth/login/route.ts` | **API Route** para iniciar sesión
| 5 | `app/api/auth/logout/route.ts` | **API Route** para cerrar sesión
| 6 | `app/api/auth/me/route.ts` | **API Route** para obtener usuario actual
| 7 | `app/login/page.tsx` | Formulario que llama a las APIs
| 8 | `scripts/001_create_profiles.sql` | Crear tabla de perfiles con roles


---

### Arquitectura del Flujo

```plaintext
┌─────────────────────────────────────────────────────────────────┐
│                        CLIENTE (Browser)                        │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  app/login/page.tsx                                      │   │
│  │  - Formulario de login                                   │   │
│  │  - fetch('/api/auth/login', { email, password })         │   │
│  │  - NO importa Supabase                                   │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        SERVIDOR (API Routes)                    │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  app/api/auth/login/route.ts                             │   │
│  │  - Importa createClient de lib/supabase/server.ts        │   │
│  │  - supabase.auth.signInWithPassword()                    │   │
│  │  - Consulta rol en tabla profiles                        │   │
│  │  - Retorna { success, user, role } o { error }           │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  app/api/auth/logout/route.ts                            │   │
│  │  - supabase.auth.signOut()                               │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  app/api/auth/me/route.ts                                │   │
│  │  - supabase.auth.getUser()                               │   │
│  │  - Retorna usuario y rol actual                          │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

---

### Detalle de cada API Route

#### 1. `POST /api/auth/login`

```typescript
// Request
{
  "email": "admin@example.com",
  "password": "password123"
}

// Response (éxito)
{
  "success": true,
  "user": {
    "id": "uuid",
    "email": "admin@example.com"
  },
  "profile": {
    "role": "super_admin",
    "first_name": "Admin",
    "last_name": "User"
  }
}

// Response (error)
{
  "success": false,
  "error": "Credenciales inválidas"
}
```

#### 2. `POST /api/auth/logout`

```typescript
// Response
{
  "success": true
}
```

#### 3. `GET /api/auth/me`

```typescript
// Response (autenticado)
{
  "authenticated": true,
  "user": {
    "id": "uuid",
    "email": "admin@example.com"
  },
  "profile": {
    "role": "novio",
    "first_name": "Juan",
    "last_name": "Pérez"
  }
}

// Response (no autenticado)
{
  "authenticated": false
}
```

---

### Estructura de Archivos Final

```plaintext
lib/
└── supabase/
    ├── server.ts          # Cliente Supabase (solo servidor)
    └── middleware.ts      # Función updateSession

app/
├── api/
│   └── auth/
│       ├── login/
│       │   └── route.ts   # POST - Iniciar sesión
│       ├── logout/
│       │   └── route.ts   # POST - Cerrar sesión
│       └── me/
│           └── route.ts   # GET - Obtener usuario actual
│
├── login/
│   └── page.tsx           # Formulario (sin Supabase)

middleware.ts              # Protección de rutas

scripts/
└── 001_create_profiles.sql # Tabla profiles + RLS
```

---

### Ventajas de este enfoque

| Aspecto | Beneficio
|-----|-----|-----
| **Seguridad** | Las credenciales de Supabase nunca se exponen al cliente
| **Separación** | El frontend no tiene dependencia directa de Supabase
| **Testabilidad** | Las APIs son fáciles de testear de forma aislada
| **Flexibilidad** | Puedes cambiar el proveedor de auth sin modificar el frontend
| **Control** | Lógica centralizada para validaciones adicionales (roles, permisos)


---

### Middleware para Protección de Rutas

El middleware verificará la sesión en cada request a `/admin/*`:

```plaintext
Request a /admin/dashboard
        │
        ▼
   middleware.ts
        │
        ├─── updateSession() refresca tokens
        │
        ├─── No hay sesión válida ──► Redirect /login
        │
        └─── Sesión válida ──► Continuar al admin
```

---

¿Deseas que proceda con la implementación de este plan?
